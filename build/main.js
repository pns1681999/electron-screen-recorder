"use strict";const o=require("electron"),l=require("fs/promises"),a=require("path");class u extends o.BrowserWindow{constructor(e){const{width:t,height:s}=e.bounds;super({width:t,height:s,x:e.bounds.x,y:e.bounds.y,hasShadow:!1,enableLargerThanScreen:!0,movable:!1,skipTaskbar:!0,frame:!1,transparent:!0,webPreferences:{preload:a.join(__dirname,"preload.js")}}),this.loadFile(a.join(__dirname,"../renderer/main_window/borderWindow.html")),this.setAlwaysOnTop(!0,"screen-saver"),this.setContentProtection(!0),this.setIgnoreMouseEvents(!0),process.platform!=="darwin"&&this.setFullScreen(!0)}}let W=class extends o.BrowserWindow{constructor(e){const{width:t,height:s}=e.bounds;super({width:t,height:s,x:e.bounds.x,y:e.bounds.y,show:!1,hasShadow:!1,enableLargerThanScreen:!0,resizable:!1,movable:!1,frame:!1,skipTaskbar:!0,transparent:!0,webPreferences:{preload:a.join(__dirname,"preload.js")}}),this.loadFile(a.join(__dirname,"../renderer/main_window/drawWindow.html")),this.setAlwaysOnTop(!0,"screen-saver"),process.platform!=="darwin"&&this.setFullScreen(!0)}};class h extends o.BrowserWindow{constructor(e){e.bounds,super({width:340,height:80,x:e.bounds.x,y:e.bounds.y,hasShadow:!1,enableLargerThanScreen:!0,resizable:!1,movable:!0,skipTaskbar:!0,frame:!1,webPreferences:{preload:a.join(__dirname,"preload.js")}}),this.loadFile(a.join(__dirname,"../renderer/main_window/actionWindow.html")),this.setAlwaysOnTop(!0,"screen-saver"),this.webContents.openDevTools({mode:"detach"}),this.setContentProtection(!0)}}class b extends o.BrowserWindow{constructor(){const e=o.screen.getPrimaryDisplay(),t=e.size.width,s=e.size.height;super({width:t,height:s,x:0,y:0,hasShadow:!1,enableLargerThanScreen:!0,movable:!0,resizable:!1,skipTaskbar:!1,webPreferences:{preload:a.join(__dirname,"preload.js")}}),this.loadFile(a.join(__dirname,"../renderer/main_window/sourceWindow.html"))}}o.app.commandLine.appendSwitch("enable-features","ScreenCaptureKitMac");o.app.setName("Yarikata");require("electron-squirrel-startup")&&o.app.quit();const r=new Map,p=n=>{const e=new u(n);r.set("borderWindow",e)},m=n=>{const e=new h(n);e.setParentWindow(r.get("borderWindow")),r.set("actionWindow",e)},g=n=>{const e=new W(n);r.set("drawWindow",e)},i=()=>{const n=new b;n.setParentWindow(r.get("borderWindow")),r.set("sourceWindow",n)},f=()=>{const n=r.get("borderWindow"),e=r.get("actionWindow"),t=r.get("drawWindow");r.has("drawWindow")&&(t.isVisible()?(n.setParentWindow(null),e.setParentWindow(null),t.hide(),e.setParentWindow(n),t.webContents.send("clear-canvas")):(t.show(),n.setParentWindow(t)))},v=n=>{p(n),m(n),g(n)},y=()=>{const n=r.get("drawWindow"),e=r.get("borderWindow"),t=r.get("actionWindow");n&&n.destroy(),e&&e.destroy(),t&&t.destroy(),r.delete("drawWindow"),r.delete("borderWindow"),r.delete("actionWindow")},S=async(n,e)=>{r.get("sourceWindow").hide();const c=o.screen.getAllDisplays().find(w=>`screen:${w.id}:0`===e);v(c),r.get("actionWindow").webContents.send("sourceId-selected",e)},_=async()=>{try{console.log("get-sources from main");const n=await o.desktopCapturer.getSources({types:["screen"]});return n.forEach(e=>{var s;if(e.thumbnail.isEmpty()){e.thumbnail=null;return}e.thumbnail=(s=e.thumbnail)==null?void 0:s.toDataURL()}),n}catch(n){return console.log("error",n),[]}},d=()=>{r.get("sourceWindow").show(),y()},P=async(n,e)=>{d();const{canceled:t,filePath:s}=await o.dialog.showSaveDialog({buttonLabel:"Save video",defaultPath:`vid-${Date.now()}.webm`});if(t){console.log("user canceled save video");return}return console.log("save video to",s),await l.writeFile(s,e),console.log("video saved successfully!"),s},T=()=>{r.get("borderWindow").webContents.send("start-record")},x=()=>{r.get("borderWindow").webContents.send("pause-record")},D=()=>{r.get("borderWindow").webContents.send("resume-record")},M=()=>{r.get("actionWindow").webContents.send("start-record-after-countdown")};o.app.on("ready",()=>{i(),o.ipcMain.handle("get-sources",_),o.ipcMain.handle("select-source",S),o.ipcMain.on("save-video",P),o.ipcMain.on("exit-record",d),o.ipcMain.on("toggle-draw",f),o.ipcMain.on("start-record",T),o.ipcMain.on("pause-record",x),o.ipcMain.on("resume-record",D),o.ipcMain.on("start-record-after-countdown",M)});o.app.on("window-all-closed",()=>{process.platform!=="darwin"&&o.app.quit()});o.app.on("activate",()=>{console.log("activate, activate"),console.log(o.BrowserWindow.getAllWindows()),o.BrowserWindow.getAllWindows().length===0&&i()});
